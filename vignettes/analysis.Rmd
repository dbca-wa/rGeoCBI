---
title: "Data analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{data-download}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rGeoCBI)
library(ruODK)
library(magrittr)
library(leaflet)
library(reactable)
```

This vignette will provide a worked example of accessing and downloading the
burn grading submissions, and calculating the GeoCBI from the raw data.

## Request an ODK Central account

Request an ODK Central account [here](https://github.com/dbca-wa/rGeoCBI/issues).
You will receive a registration email. Your username will be your email address,
you can choose your own password. With those credentials, you have read access
to ODK Central, the place where burn grading submissions are uploaded to.

This step is required only once for every data analyst.

## Setup ruODK
For details, refer to 
[ruODK vignette "setup"](https://dbca-wa.github.io/ruODK/articles/setup.html).

Set default credentials and settings to simplify work with `ruODK` later.
Credentials live as environment variables in your `.Renviron` file.
Changes to `.Renviron` require a restart of the R session.

```{r, eval=F}
usethis::edit_r_environ()

# Paste with your credentials
ODKC_URL="https://odkcentral.dbca.wa.gov.au"
ODKC_UN="YOUR_EMAIL"
ODKC_PW="YOUR_PASSWORD"
ODKC_PID=27
ODKC_FID="build_Burn-Grading-0-1_1578487677"

# Save .Renviron and restart your R session.
```

Since we'll only work with one form and have set the neccessary settings as defaults, 
`ruODK` will default to our form without any further ado.

If you need to navigate between forms, you can setup `ruODK` with the
respective OData service URL:

```{r, eval=F}
# ODK Central's OData URL contains base URL, project ID, and form ID
# ODK Central credentials can live in .Renviron, see vignette "setup"
ruODK::ru_setup(
  svc = paste0("https://odkcentral.dbca.wa.gov.au/v1/projects/27/",
               "forms/build_Burn-Grading-0-1_1578487677.svc"),
  un = Sys.getenv("ODKC_UN"),
  pw = Sys.getenv("ODKC_PW")
)
```

## Download data
For an overview on accessing data from ODK Central, read the 
[ODK Central docs](https://docs.opendatakit.org/central-submissions/#).

For a background on accessing data from R, refer to 
[ruODK vignette "odata-api"](https://dbca-wa.github.io/ruODK/articles/odata-api.html).

In a pinch, we can always download a ZIP archive of all submissions and all
photos from ODK Central.

Here, we'll use `ruODK` to download submissions from ODK Central.

```{r, eval=F}
tz <- "Australia/Perth"
loc <- fs::path("media")

# There is only one table in this form, no repeting subgroups
bg_svc <- ruODK::odata_service_get()
bg_svc %>% knitr::kable(.)

# The submission data
# bg_data <- ruODK::odata_submission_get(verbose = TRUE, tz = tz, local_dir = loc)
```

## Calculate GeoCBI

Parse raw data into numeric scale values, apply GeoCBI formula.

TODO: write helpers as R functions.

## Visualise

TODO: use actual data.

### Map

```{r}
leaflet::leaflet(width = 800, height = 600) %>%
    leaflet::addProviderTiles("Esri.WorldImagery", group = "Aerial") %>%
    leaflet::addProviderTiles("OpenStreetMap.Mapnik", group = "Place names") %>%
    leaflet::clearBounds() %>%
    leaflet::setView(130,-33, 4) %>% 
    # leaflet::addAwesomeMarkers(
      #   data = bg_data,
      #   lng = ~location_longitude, lat = ~location_latitude,
      #   icon = leaflet::makeAwesomeIcon(text = "X", markerColor = "red"),
      #   # label = ~ glue::glue("{plot_name} {observation_start_datetime}"),
      #   # popup = ~ glue::glue(
      #     # "<h3>{plot_name}</h3>",
      #     # "Survey start {observation_start_datetime}</br>",
      #     # "Reporter {reporter}</br>",
      #     # "Device {device_id}</br>",
      #     # "<h5>Plot</h5>",
      #     # '<div><img src="{plot_photo}"',
      #     # ' height="150px" alt="Plot photo"></img></div>',
      #   # ),
      #   clusterOptions = leaflet::markerClusterOptions()
      # ) %>%
      leaflet::addLayersControl(
        baseGroups = c("Aerial", "Place names"),
        # overlayGroups = "",
        options = leaflet::layersControlOptions(collapsed = FALSE)
      )

```

### Table

```{r}
data("mtcars")
head(mtcars) %>% reactable::reactable(sortable = T, filterable = T)
```


## Publish

Options:

* Upload results to CKAN data catalogue to share with DBCA colleagues.
* Upload results to Google Drive folder to share with external collaborators.
