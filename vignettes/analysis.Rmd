---
title: "Data analysis"
output: 
  rmarkdown::html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: yeti
    highlight: tango
resource_files:
- man/figures/odk/1578488994992.jpg
- man/figures/odk/1578489033729.jpg
- man/figures/odk/1578489072292.jpg
- man/figures/odk/1578489127335.jpg
- man/figures/odk/1578489161012.jpg
- man/figures/odk/1578489206390.jpg
- man/figures/odk/1578785576392.jpg
- man/figures/odk/1578785648115.jpg
- man/figures/odk/1578785727152.jpg
- man/figures/odk/1578785808711.jpg
- man/figures/odk/1578785863925.jpg
- man/figures/odk/1578785920077.jpg
vignette: >
  %\VignetteIndexEntry{data-analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rGeoCBI)
library(ruODK)
library(magrittr)
library(leaflet)
library(reactable)
```

This vignette will provide a worked example of accessing and downloading the
burn grading submissions, and calculating the GeoCBI from the raw data.

## Request an ODK Central account

Request an ODK Central account [here](https://github.com/dbca-wa/rGeoCBI/issues).
You will receive a registration email. Your username will be your email address,
you can choose your own password. With those credentials, you have read access
to ODK Central, the place where burn grading submissions are uploaded to.

This step is required only once for every data analyst.

## Setup ruODK
For details, refer to 
[ruODK vignette "setup"](https://dbca-wa.github.io/ruODK/articles/setup.html).

Set default credentials and settings to simplify work with `ruODK` later.
Credentials live as environment variables in your `.Renviron` file.
Changes to `.Renviron` require a restart of the R session.

```{r, eval=F}
usethis::edit_r_environ()

# Paste with your credentials
ODKC_URL="https://odkcentral.dbca.wa.gov.au"
ODKC_UN="YOUR_EMAIL"
ODKC_PW="YOUR_PASSWORD"
ODKC_PID=27
ODKC_FID="build_Burn-Grading-0-1_1578487677"

# Save .Renviron and restart your R session.
```

Since we'll only work with one form and have set the neccessary settings as defaults, 
`ruODK` will default to our form without any further ado.

If you need to navigate between forms, you can setup `ruODK` with the
respective OData service URL:

```{r}
# ODK Central's OData URL contains base URL, project ID, and form ID
# ODK Central credentials can live in .Renviron, see vignette "setup"
ruODK::ru_setup(
  svc = paste0("https://odkcentral.dbca.wa.gov.au/v1/projects/27/",
               "forms/build_Burn-Grading-0-1_1578487677.svc"),
  un = Sys.getenv("ODKC_UN"),
  pw = Sys.getenv("ODKC_PW")
)
```

## Download data
For an overview on accessing data from ODK Central, read the 
[ODK Central docs](https://docs.opendatakit.org/central-submissions/#).

For a background on accessing data from R, refer to 
[ruODK vignette "odata-api"](https://dbca-wa.github.io/ruODK/articles/odata-api.html).

In a pinch, we can always download a ZIP archive of all submissions and all
photos from ODK Central.

Here, we'll use `ruODK` to download submissions from ODK Central.

```{r, eval=FALSE}
burngrading01 <- ruODK::odata_submission_get(
  verbose = T, 
  tz = "Australia/Perth", 
  local_dir = fs::path("media"), 
  wkt=T
)
```

```{r, echo=F}
data("burngrading01")
```

## Calculate GeoCBI

Parse raw data into numeric scale values, apply GeoCBI formula.

Values are coded as `<grade>_<url-safe-label>`, where grade are numbers 0.0, 0.5,
1.0, 1.5 through to 3.0, and the labels are intelligible but url-safe variable
names. Fraction of coverages (fcov) also are prefixed with their grade, which
ranges from 0.0 to 1.0 in increments of 0.25.

```{r}
bg_geocbi <- burngrading01 %>% add_geocbi()
```

## Visualise
The data shown here are test data (not real burn gradings) and 
come from the real form.

### Map
The helper function `map_burngrading()` provides a leaflet map with labels and popups.
The source code of `map_burngrading()` can serve as a starting point for other
customised maps.

```{r}
bg_geocbi %>% map_burngrading()
```


### Table
Each row expands to show details. Here, we show all linked photos, but the
function to display details could be expanded to include more details.

```{r}
bg_geocbi %>% reactable::reactable(
  sortable = T,
  filterable = T,
  details = function(index) {
    htmltools::tags$div(
      htmltools::tags$img(
        width="200px;", alt="Plot photo", src=bg_geocbi[index,]$plot_photo),
      htmltools::tags$img(
        width="200px;", alt="Stratum 1 photo", src=bg_geocbi[index,]$s1_photo),
      htmltools::tags$img(
        width="200px;", alt="Stratum 2 photo", src=bg_geocbi[index,]$s2_photo),
      htmltools::tags$img(
        width="200px;", alt="Stratum 3 photo", src=bg_geocbi[index,]$s3_photo),
      htmltools::tags$img(
        width="200px;", alt="Stratum 4 photo", src=bg_geocbi[index,]$s4_photo),
      htmltools::tags$img(
        width="200px;", alt="Stratum 5 photo", src=bg_geocbi[index,]$s5_photo)
    )})
```

## Publish

Options:

* Upload results to CKAN data catalogue to share with DBCA colleagues.
* Upload results to Google Drive folder to share with external collaborators.
